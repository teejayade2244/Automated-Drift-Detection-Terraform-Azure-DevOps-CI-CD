trigger: none

schedules:
- cron: "0 9 * * *"
  displayName: Daily Terraform Drift Detection
  branches:
    include:
    - master
  always: true

variables:
  - group: SlackSecrets  
  - name: terraformVersion
    value: '1.5.0'
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)/terraform'
  - name: azureServiceConnection
    value: 'Azure-Resource-Manager' 
  - name: tfBackendResourceGroup
    value: 'Temitope'
  - name: tfBackendStorageAccount
    value: 'sttfstateorageacc'
  - name: tfBackendContainer
    value: 'tfstate'
  - name: tfBackendKey
    value: 'drift-detection.tfstate'

# Self-hosted agent pool
pool:
  name: 'Pipeline Agent'
  demands:
  - agent.os -equals Linux

stages:

# --------------------------------------------------
# TERRAFORM DRIFT DETECTION
# --------------------------------------------------
- stage: DriftDetection
  displayName: Terraform Drift Detection

  jobs:
  - job: DetectDrift
    displayName: Install, Init, Validate & Plan
    pool:
      name: 'Pipeline Agent'

    steps:
    - checkout: self
      displayName: 'Checkout Repository'

    # Install Azure CLI on self-hosted agent
    - task: Bash@3
      displayName: 'Install Azure CLI'
      inputs:
        targetType: 'inline'
        script: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az --version

    # Verify environment and directory structure
    - task: Bash@3
      displayName: 'Verify Directory Structure'
      inputs:
        targetType: 'inline'
        script: |
          echo "Current directory: $(pwd)"
          echo "Listing working directory:"
          ls -la
          echo "Checking for terraform directory:"
          find . -name "terraform" -type d
          echo "Creating terraform directory if it doesn't exist"
          mkdir -p $(workingDirectory)

    # Verify Terraform is accessible
    - task: Bash@3
      displayName: 'Verify Terraform Installation'
      inputs:
        targetType: 'inline'
        script: |
          echo "Checking Terraform installation..."
          which terraform
          terraform version
          echo "Terraform is properly installed"

    # Terraform Init using environment variables
    - task: Bash@3
      displayName: 'Terraform Init'
      inputs:
        targetType: 'inline'
        script: |
          echo "Working directory: $(workingDirectory)"
          cd $(workingDirectory)
          echo "Current directory after cd: $(pwd)"
          echo "Initializing Terraform backend..."
          
          # Use environment variables for authentication
          terraform init \
            -backend-config="storage_account_name=$(tfBackendStorageAccount)" \
            -backend-config="container_name=$(tfBackendContainer)" \
            -backend-config="key=$(tfBackendKey)" \
            -backend-config="resource_group_name=$(tfBackendResourceGroup)" \
            -backend-config="subscription_id=$ARM_SUBSCRIPTION_ID" \
            -backend-config="tenant_id=$ARM_TENANT_ID" \
            -backend-config="client_id=$ARM_CLIENT_ID" \
            -backend-config="client_secret=$ARM_CLIENT_SECRET"
          
          echo "Terraform init completed with exit code: $?"

    # Terraform Validate
    - task: Bash@3
      displayName: 'Terraform Validate'
      inputs:
        targetType: 'inline'
        script: |
          cd $(workingDirectory)
          echo "Validating Terraform configuration..."
          terraform validate
          echo "Validation completed with exit code: $?"

    # Terraform Plan via script
    - task: Bash@3
      name: AnalyzeExitCode
      displayName: 'Terraform Plan & Analyze Exit Code'
      inputs:
        script: |
          cd $(workingDirectory)
        targetType: 'filePath'
        filePath: '$(workingDirectory)/drift_detection.sh'
        workingDirectory: '$(workingDirectory)'
      env:
        ARM_CLIENT_ID: $(servicePrincipalId)
        ARM_CLIENT_SECRET: $(servicePrincipalKey)
        ARM_TENANT_ID: $(tenantId)
        ARM_SUBSCRIPTION_ID: $(subscriptionId)

    # Publish tfplan
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Terraform Plan Artifact'
      condition: succeededOrFailed()
      inputs:
        PathtoPublish: '$(workingDirectory)/tfplan'
        ArtifactName: 'terraform-drift-plan-$(Build.BuildId)'
        publishLocation: 'Container'

    # Publish drift report if drift detected
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Drift Report'
      condition: and(succeededOrFailed(), eq(variables['AnalyzeExitCode.planExitCode'], '2'))
      inputs:
        PathtoPublish: '$(workingDirectory)/drift-report.txt'
        ArtifactName: 'drift-report-$(Build.BuildId)'
        publishLocation: 'Container'


# --------------------------------------------------
# SLACK NOTIFICATION STAGE
# --------------------------------------------------
- stage: Notify
  displayName: "üí¨ Send Notifications"
  dependsOn: DriftDetection
  condition: always()

  jobs:
  - job: SendSlackNotification
    displayName: Send Slack Alert
    pool:
      name: 'Pipeline Agent'

    variables:
      planExitCode: $[ stageDependencies.DriftDetection.DetectDrift.outputs['AnalyzeExitCode.planExitCode'] ]

    steps:
    - task: Bash@3
      displayName: 'Send Slack Drift Notification'
      inputs:
        targetType: inline
        script: |
          EXIT_CODE="$(planExitCode)"

          PIPELINE_URL="$(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
          NOW=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          case "$EXIT_CODE" in
            0)
              COLOR="good"
              MESSAGE="‚úÖ *No Drift Detected*\nEverything is up to date."
              ;;
            2)
              COLOR="warning"
              MESSAGE="‚ö†Ô∏è *Terraform Drift Detected!*\nReview the Terraform plan."
              ;;
            1)
              COLOR="danger"
              MESSAGE="‚ùå *Terraform Error*\nPlan failed. Check logs."
              ;;
            *)
              COLOR="#808080"
              MESSAGE="‚ùì *Unknown Exit Code:* \`$EXIT_CODE\`"
              ;;
          esac

          MESSAGE="$MESSAGE\n\n‚Ä¢ Build: \`$(Build.BuildNumber)\`\n‚Ä¢ Branch: \`$(Build.SourceBranchName)\`\n‚Ä¢ Time: \`$NOW\`\n‚Ä¢ <$PIPELINE_URL|View Pipeline>"

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"text\": \"$MESSAGE\",
                \"footer\": \"Azure DevOps - Terraform Drift Detection\",
                \"ts\": $(date +%s)
              }]
            }" \
            "$(SLACK_WEBHOOK_URL)"

          echo "Slack notification sent."