trigger: none

schedules:
- cron: "0 9 * * *"
  displayName: Daily Terraform Drift Detection
  branches:
    include:
    - master
  always: true

variables:
  - group: SlackSecrets  
  - name: terraformVersion
    value: '1.5.0'
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)/terraform'
  - name: azureServiceConnection
    value: 'Azure-Resource-Manager' 
  - name: tfBackendResourceGroup
    value: 'Temitope'
  - name: tfBackendStorageAccount
    value: 'sttfstateorageacc'
  - name: tfBackendContainer
    value: 'tfstate'
  - name: tfBackendKey
    value: 'drift-detection.tfstate'

# Self-hosted agent pool
pool:
  name: 'Pipeline Agent'
  demands:
  - agent.os -equals Linux

stages:

# --------------------------------------------------
# TERRAFORM DRIFT DETECTION
# --------------------------------------------------
- stage: DriftDetection
  displayName: Terraform Drift Detection

  jobs:
  - job: DetectDrift
    displayName: Install, Init, Validate & Plan
    pool:
      name: 'Pipeline Agent'

    steps:
    - checkout: self
      displayName: 'Checkout Repository'

    # Install Terraform
    # - task: TerraformInstaller@1
    #   displayName: 'Install Terraform'
    #   inputs:
    #     terraformVersion: $(terraformVersion)

    # Terraform Init
    - task: TerraformTaskV4@4
      displayName: 'Terraform Init'
      inputs:
        provider: azurerm
        command: init
        terraformPath: '/usr/bin/terraform'
        workingDirectory: $(workingDirectory)
        backendServiceArm: $(azureServiceConnection)
        backendAzureRmResourceGroupName: $(tfBackendResourceGroup)
        backendAzureRmStorageAccountName: $(tfBackendStorageAccount)
        backendAzureRmContainerName: $(tfBackendContainer)
        backendAzureRmKey: $(tfBackendKey)

    # Terraform Validate
    - task: TerraformTaskV4@4
      displayName: 'Terraform Validate'
      inputs:
        provider: azurerm
        command: validate
        terraformPath: '/usr/bin/terraform'
        workingDirectory: $(workingDirectory)

    # Terraform Plan via script
    - task: Bash@3
      name: AnalyzeExitCode
      displayName: 'Terraform Plan & Analyze Exit Code'
      inputs:
        targetType: 'filePath'
        filePath: '$(workingDirectory)/drift_detection.sh'
        workingDirectory: '$(workingDirectory)'
      env:
        ARM_CLIENT_ID: $(servicePrincipalId)
        ARM_CLIENT_SECRET: $(servicePrincipalKey)
        ARM_TENANT_ID: $(tenantId)
        ARM_SUBSCRIPTION_ID: $(subscriptionId)

    # Publish tfplan
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Terraform Plan Artifact'
      condition: succeededOrFailed()
      inputs:
        PathtoPublish: '$(workingDirectory)/tfplan'
        ArtifactName: 'terraform-drift-plan-$(Build.BuildId)'
        publishLocation: 'Container'

    # Publish drift report if drift detected
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Drift Report'
      condition: and(succeededOrFailed(), eq(variables['AnalyzeExitCode.planExitCode'], '2'))
      inputs:
        PathtoPublish: '$(workingDirectory)/drift-report.txt'
        ArtifactName: 'drift-report-$(Build.BuildId)'
        publishLocation: 'Container'


# --------------------------------------------------
# SLACK NOTIFICATION STAGE
# --------------------------------------------------
- stage: Notify
  displayName: "üí¨ Send Notifications"
  dependsOn: DriftDetection
  condition: always()

  jobs:
  - job: SendSlackNotification
    displayName: Send Slack Alert
    pool:
      name: 'Pipeline Agent'

    variables:
      planExitCode: $[ stageDependencies.DriftDetection.DetectDrift.outputs['AnalyzeExitCode.planExitCode'] ]

    steps:
    - task: Bash@3
      displayName: 'Send Slack Drift Notification'
      inputs:
        targetType: inline
        script: |
          EXIT_CODE="$(planExitCode)"

          PIPELINE_URL="$(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
          NOW=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          case "$EXIT_CODE" in
            0)
              COLOR="good"
              MESSAGE="‚úÖ *No Drift Detected*\nEverything is up to date."
              ;;
            2)
              COLOR="warning"
              MESSAGE="‚ö†Ô∏è *Terraform Drift Detected!*\nReview the Terraform plan."
              ;;
            1)
              COLOR="danger"
              MESSAGE="‚ùå *Terraform Error*\nPlan failed. Check logs."
              ;;
            *)
              COLOR="#808080"
              MESSAGE="‚ùì *Unknown Exit Code:* \`$EXIT_CODE\`"
              ;;
          esac

          MESSAGE="$MESSAGE\n\n‚Ä¢ Build: \`$(Build.BuildNumber)\`\n‚Ä¢ Branch: \`$(Build.SourceBranchName)\`\n‚Ä¢ Time: \`$NOW\`\n‚Ä¢ <$PIPELINE_URL|View Pipeline>"

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"text\": \"$MESSAGE\",
                \"footer\": \"Azure DevOps - Terraform Drift Detection\",
                \"ts\": $(date +%s)
              }]
            }" \
            $SLACK_WEBHOOK_URL

          echo "Slack notification sent."
